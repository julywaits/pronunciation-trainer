<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å‘éŸ³è‚Œè‚‰è®°å¿†è®­ç»ƒå™¨</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400;500&family=Outfit:wght@300;400;500;600;700&display=swap');

        :root {
            --bg-deep: #0a0a0f;
            --bg-card: #13131a;
            --bg-elevated: #1a1a24;
            --bg-hover: #22222e;
            --accent: #ff6b35;
            --accent-glow: rgba(255, 107, 53, 0.3);
            --accent-soft: rgba(255, 107, 53, 0.1);
            --green: #22c55e;
            --green-glow: rgba(34, 197, 94, 0.3);
            --red: #ef4444;
            --red-glow: rgba(239, 68, 68, 0.3);
            --yellow: #eab308;
            --text-primary: #e8e6e3;
            --text-secondary: #8a8694;
            --text-dim: #4a4658;
            --border: rgba(255, 255, 255, 0.06);
            --radius: 12px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Outfit', -apple-system, sans-serif;
            background: var(--bg-deep);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        .app-container {
            max-width: 520px;
            margin: 0 auto;
            padding: 16px 16px 120px;
        }

        header { text-align: center; padding: 24px 0 20px; }

        header h1 {
            font-family: 'DM Mono', monospace;
            font-size: 15px;
            font-weight: 400;
            letter-spacing: 3px;
            text-transform: uppercase;
            color: var(--accent);
            margin-bottom: 4px;
        }

        header p {
            font-size: 12px;
            color: var(--text-dim);
            letter-spacing: 1px;
        }

        /* TABS */
        .tab-bar {
            display: flex; gap: 2px;
            background: var(--bg-card);
            border-radius: 10px; padding: 3px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
        }

        .tab-btn {
            flex: 1; padding: 10px 6px;
            background: none; border: none;
            color: var(--text-secondary);
            font-family: 'Outfit', sans-serif;
            font-size: 13px; font-weight: 500;
            cursor: pointer; border-radius: 8px;
            transition: all 0.2s;
        }
        .tab-btn:hover { color: var(--text-primary); }
        .tab-btn.active {
            background: var(--bg-elevated);
            color: var(--accent);
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* CARDS */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 20px; margin-bottom: 12px;
        }
        .card-title {
            font-size: 11px; font-weight: 500;
            text-transform: uppercase; letter-spacing: 2px;
            color: var(--text-dim); margin-bottom: 14px;
        }

        /* WORD HERO */
        .word-hero { text-align: center; padding: 30px 10px; }
        .word-hero .word {
            font-size: 42px; font-weight: 700;
            letter-spacing: -1px; margin-bottom: 8px; line-height: 1.1;
        }
        .word-hero .phonetic {
            font-family: 'DM Mono', monospace;
            font-size: 20px; color: var(--accent); margin-bottom: 6px;
        }
        .word-hero .translation {
            font-size: 14px; color: var(--text-secondary); margin-bottom: 4px;
        }
        .word-hero .tip {
            font-size: 12px; color: var(--text-dim); line-height: 1.6;
            max-width: 360px; margin: 10px auto 0;
            padding: 10px 14px; background: var(--accent-soft);
            border-radius: 8px; border-left: 3px solid var(--accent);
        }

        /* RECORD BUTTON */
        .record-area {
            display: flex; flex-direction: column;
            align-items: center; padding: 20px 0;
        }
        .record-btn {
            width: 80px; height: 80px; border-radius: 50%;
            border: 3px solid var(--accent); background: var(--bg-card);
            cursor: pointer; display: flex;
            align-items: center; justify-content: center;
            transition: all 0.2s; position: relative;
        }
        .record-btn:hover { background: var(--accent-soft); transform: scale(1.05); }
        .record-btn.recording {
            border-color: var(--red); background: var(--red-glow);
            animation: pulse-record 1.2s ease-in-out infinite;
        }
        .record-btn .mic-icon {
            width: 28px; height: 28px; fill: var(--accent); transition: fill 0.2s;
        }
        .record-btn.recording .mic-icon { fill: var(--red); }

        @keyframes pulse-record {
            0%, 100% { box-shadow: 0 0 0 0 var(--red-glow); }
            50% { box-shadow: 0 0 0 16px transparent; }
        }

        .record-hint { margin-top: 12px; font-size: 12px; color: var(--text-dim); }
        .record-hint.listening { color: var(--red); }

        /* PLAY STANDARD */
        .play-standard-btn {
            display: flex; align-items: center; gap: 8px;
            padding: 10px 20px; background: var(--bg-elevated);
            border: 1px solid var(--border); border-radius: 20px;
            color: var(--text-primary); font-family: 'Outfit', sans-serif;
            font-size: 13px; cursor: pointer; transition: all 0.2s;
            margin: 0 auto 16px;
        }
        .play-standard-btn:hover { background: var(--bg-hover); border-color: var(--accent); }
        .play-standard-btn svg { width: 16px; height: 16px; fill: var(--accent); }

        /* FEEDBACK */
        .feedback-panel {
            text-align: center; padding: 16px;
            border-radius: var(--radius); margin-top: 12px; display: none;
        }
        .feedback-panel.show { display: block; }
        .feedback-panel.correct { background: rgba(34,197,94,0.08); border: 1px solid rgba(34,197,94,0.2); }
        .feedback-panel.wrong { background: rgba(239,68,68,0.08); border: 1px solid rgba(239,68,68,0.2); }
        .feedback-panel.partial { background: rgba(234,179,8,0.08); border: 1px solid rgba(234,179,8,0.2); }

        .feedback-score { font-size: 48px; font-weight: 700; }
        .feedback-panel.correct .feedback-score { color: var(--green); }
        .feedback-panel.wrong .feedback-score { color: var(--red); }
        .feedback-panel.partial .feedback-score { color: var(--yellow); }

        .feedback-label { font-size: 13px; color: var(--text-secondary); margin-top: 4px; }
        .feedback-detail {
            font-size: 12px; color: var(--text-dim);
            margin-top: 8px; line-height: 1.6;
            text-align: left; white-space: pre-wrap;
        }
        .recognized-text {
            font-family: 'DM Mono', monospace; font-size: 14px;
            color: var(--text-secondary); margin-top: 8px;
            padding: 8px 12px; background: var(--bg-deep);
            border-radius: 6px; display: inline-block;
        }

        /* NEXT BUTTON */
        .next-btn {
            display: block; width: 100%; padding: 14px; margin-top: 16px;
            background: var(--accent); color: #fff; border: none;
            border-radius: 10px; font-family: 'Outfit', sans-serif;
            font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.15s;
        }
        .next-btn:hover { filter: brightness(1.1); transform: translateY(-1px); }
        .next-btn:active { transform: translateY(0); }

        /* CATEGORY PILLS */
        .category-pills { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 16px; }
        .pill {
            padding: 6px 14px; background: var(--bg-elevated);
            border: 1px solid var(--border); border-radius: 20px;
            font-size: 12px; color: var(--text-secondary);
            cursor: pointer; transition: all 0.15s; white-space: nowrap;
        }
        .pill:hover { border-color: var(--accent); color: var(--text-primary); }
        .pill.active { background: var(--accent-soft); border-color: var(--accent); color: var(--accent); }

        /* WORD LIST */
        .word-list-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 12px 14px; border-bottom: 1px solid var(--border);
            cursor: pointer; transition: background 0.15s;
        }
        .word-list-item:hover { background: var(--bg-hover); }
        .word-list-item:last-child { border-bottom: none; }
        .word-list-item .wl-word { font-weight: 500; font-size: 15px; }
        .word-list-item .wl-phonetic {
            font-family: 'DM Mono', monospace; font-size: 12px;
            color: var(--accent); margin-top: 2px;
        }
        .word-list-item .wl-status {
            font-size: 11px; padding: 3px 10px; border-radius: 10px; font-weight: 500;
        }
        .wl-status.mastered { background: rgba(34,197,94,0.15); color: var(--green); }
        .wl-status.practicing { background: rgba(234,179,8,0.15); color: var(--yellow); }
        .wl-status.new { background: rgba(255,255,255,0.05); color: var(--text-dim); }

        /* STATS */
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 16px; }
        .stat-box { background: var(--bg-elevated); border-radius: 10px; padding: 16px; text-align: center; }
        .stat-value { font-size: 28px; font-weight: 700; color: var(--accent); }
        .stat-label {
            font-size: 11px; color: var(--text-dim); margin-top: 4px;
            text-transform: uppercase; letter-spacing: 1px;
        }

        /* TROUBLE LIST */
        .trouble-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 10px 14px; border-bottom: 1px solid var(--border);
        }
        .trouble-item:last-child { border-bottom: none; }
        .trouble-word { font-weight: 500; }
        .trouble-pattern { font-family: 'DM Mono', monospace; font-size: 12px; color: var(--red); }
        .trouble-count { font-size: 12px; color: var(--text-dim); }

        /* PROGRESS BAR */
        .progress-bar-bg {
            width: 100%; height: 6px; background: var(--bg-deep);
            border-radius: 3px; overflow: hidden; margin: 8px 0;
        }
        .progress-bar-fill {
            height: 100%; background: var(--accent);
            border-radius: 3px; transition: width 0.4s ease;
        }

        /* CHALLENGE */
        .challenge-timer {
            font-family: 'DM Mono', monospace; font-size: 36px;
            text-align: center; color: var(--accent); margin: 16px 0;
        }
        .challenge-progress { text-align: center; font-size: 13px; color: var(--text-secondary); margin-bottom: 16px; }
        .streak-display { text-align: center; margin: 10px 0; }
        .streak-count { font-size: 18px; font-weight: 600; color: var(--green); }
        .streak-label { font-size: 11px; color: var(--text-dim); }

        /* CONFIG */
        .config-row {
            display: flex; align-items: center; justify-content: space-between;
            padding: 12px 0; border-bottom: 1px solid var(--border);
        }
        .config-row:last-child { border-bottom: none; }
        .config-label { font-size: 14px; color: var(--text-secondary); }
        .config-sublabel { font-size: 11px; color: var(--text-dim); margin-top: 2px; }
        .config-input {
            background: var(--bg-elevated); border: 1px solid var(--border);
            border-radius: 8px; padding: 6px 12px; color: var(--text-primary);
            font-family: 'DM Mono', monospace; font-size: 13px;
            width: 120px; text-align: center;
        }
        .config-input:focus { outline: none; border-color: var(--accent); }
        select.config-input { cursor: pointer; -webkit-appearance: none; }

        /* API CONFIG */
        .api-config { margin-bottom: 16px; }
        .api-input-group { display: flex; gap: 8px; margin-top: 8px; }
        .api-input {
            flex: 1; background: var(--bg-elevated); border: 1px solid var(--border);
            border-radius: 8px; padding: 10px 14px; color: var(--text-primary);
            font-family: 'DM Mono', monospace; font-size: 12px;
        }
        .api-input:focus { outline: none; border-color: var(--accent); }
        .api-input::placeholder { color: var(--text-dim); }
        .api-save-btn {
            padding: 10px 18px; background: var(--accent); border: none;
            border-radius: 8px; color: #fff; font-family: 'Outfit', sans-serif;
            font-size: 13px; font-weight: 500; cursor: pointer;
        }
        .api-status { font-size: 11px; margin-top: 6px; color: var(--text-dim); }
        .api-status.connected { color: var(--green); }
        .api-status.error { color: var(--red); }

        /* SPEED */
        .speed-control {
            display: flex; align-items: center; gap: 12px;
            justify-content: center; margin: 12px 0;
        }
        .speed-btn {
            width: 32px; height: 32px; border-radius: 50%;
            background: var(--bg-elevated); border: 1px solid var(--border);
            color: var(--text-secondary); font-size: 16px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .speed-btn:hover { border-color: var(--accent); color: var(--accent); }
        .speed-label {
            font-family: 'DM Mono', monospace; font-size: 13px;
            color: var(--text-secondary); min-width: 50px; text-align: center;
        }

        /* MODEL SELECT */
        .model-select {
            width: 100%; background: var(--bg-elevated); border: 1px solid var(--border);
            border-radius: 8px; padding: 8px 12px; color: var(--text-primary);
            font-family: 'DM Mono', monospace; font-size: 12px;
            cursor: pointer; -webkit-appearance: none; margin-top: 6px;
        }
        .model-select:focus { outline: none; border-color: var(--accent); }

        /* MISC */
        .hidden { display: none !important; }
        .divider { height: 1px; background: var(--border); margin: 16px 0; }
        .section-title { font-size: 13px; font-weight: 600; color: var(--text-primary); margin-bottom: 10px; }
        .empty-state { text-align: center; padding: 40px 20px; color: var(--text-dim); }
        .empty-state .emoji { font-size: 40px; margin-bottom: 12px; }
        .empty-state p { font-size: 13px; line-height: 1.6; }

        /* Loading spinner */
        .loading-spinner {
            display: inline-block; width: 20px; height: 20px;
            border: 2px solid var(--text-dim); border-top-color: var(--accent);
            border-radius: 50%; animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* AI Generate */
        .ai-generate-btn {
            display: flex; align-items: center; justify-content: center; gap: 8px;
            width: 100%; padding: 12px; background: var(--bg-elevated);
            border: 1px dashed var(--accent); border-radius: 10px;
            color: var(--accent); font-family: 'Outfit', sans-serif;
            font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.2s;
        }
        .ai-generate-btn:hover { background: var(--accent-soft); }

        .ai-phrase-item {
            padding: 12px 14px; margin-bottom: 8px;
            background: var(--bg-elevated); border-radius: 8px;
            border-left: 3px solid var(--accent); cursor: pointer;
            transition: all 0.15s;
        }
        .ai-phrase-item:hover { background: var(--bg-hover); }
        .ai-phrase-word { font-size: 15px; font-weight: 500; margin-bottom: 2px; }
        .ai-phrase-ipa { font-family: 'DM Mono', monospace; font-size: 12px; color: var(--accent); }
        .ai-phrase-zh { font-size: 12px; color: var(--text-secondary); margin-top: 2px; }
        .ai-phrase-focus { font-size: 11px; color: var(--yellow); margin-top: 4px; }

        @media (max-width: 400px) {
            .word-hero .word { font-size: 32px; }
            .word-hero .phonetic { font-size: 17px; }
        }
    </style>
</head>
<body>

<div class="app-container">
    <header>
        <h1>PRONUNCIATION</h1>
        <p>è‚Œè‚‰è®°å¿†è®­ç»ƒå™¨ Â· ä¸­å›½äººæ˜“é”™å‘éŸ³</p>
    </header>

    <div class="tab-bar">
        <button class="tab-btn active" data-tab="train">è®­ç»ƒ</button>
        <button class="tab-btn" data-tab="browse">è¯åº“</button>
        <button class="tab-btn" data-tab="challenge">é—¯å…³</button>
        <button class="tab-btn" data-tab="report">æŠ¥å‘Š</button>
    </div>

    <!-- TAB 1: TRAIN -->
    <div class="tab-content active" id="tab-train">
        <div class="category-pills" id="trainCategoryPills"></div>
        <div class="card">
            <div class="word-hero" id="wordHero">
                <div class="word" id="heroWord">think</div>
                <div class="phonetic" id="heroPhonetic">/Î¸ÉªÅ‹k/</div>
                <div class="translation" id="heroTranslation">æƒ³ï¼Œè®¤ä¸º</div>
                <div class="tip" id="heroTip"></div>
            </div>
        </div>

        <div class="speed-control">
            <button class="speed-btn" id="speedDown">âˆ’</button>
            <span class="speed-label" id="speedLabel">1.0x</span>
            <button class="speed-btn" id="speedUp">+</button>
        </div>

        <button class="play-standard-btn" id="playStandardBtn">
            <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
            æ’­æ”¾æ ‡å‡†å‘éŸ³
        </button>

        <div class="record-area">
            <button class="record-btn" id="recordBtn">
                <svg class="mic-icon" viewBox="0 0 24 24">
                    <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm-1-9c0-.55.45-1 1-1s1 .45 1 1v6c0 .55-.45 1-1 1s-1-.45-1-1V5z"/>
                    <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
                </svg>
            </button>
            <div class="record-hint" id="recordHint">ç‚¹å‡»å¼€å§‹å½•éŸ³</div>
        </div>

        <div class="feedback-panel" id="feedbackPanel">
            <div class="feedback-score" id="feedbackScore">â€”</div>
            <div class="feedback-label" id="feedbackLabel"></div>
            <div class="recognized-text" id="recognizedText"></div>
            <div class="feedback-detail" id="feedbackDetail"></div>
        </div>

        <div style="text-align:center; margin-top:10px;">
            <span style="font-size:12px; color:var(--text-dim);" id="repeatCounter">æœ¬è¯ç»ƒä¹  0 æ¬¡</span>
        </div>

        <button class="next-btn" id="nextBtn">ä¸‹ä¸€ä¸ªè¯ â†’</button>

        <!-- AI Generate Section -->
        <div class="divider"></div>
        <div class="card" id="aiGenerateCard">
            <div class="card-title">AI é’ˆå¯¹æ€§é€ å¥</div>
            <div style="font-size:12px; color:var(--text-dim); margin-bottom:12px;">æ ¹æ®ä½ çš„è–„å¼±ç‚¹ï¼Œè®© Gemini ç°åœºç”Ÿæˆç»ƒä¹ çŸ­å¥</div>
            <button class="ai-generate-btn" id="aiGenerateBtn">
                <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
                ç”Ÿæˆé’ˆå¯¹æ€§ç»ƒä¹ å¥
            </button>
            <div id="aiGeneratedList" class="hidden">
                <div style="margin-top:12px;" id="aiGeneratedContent"></div>
            </div>
            <div id="aiGenerateLoading" class="hidden" style="text-align:center; padding:16px;">
                <span class="loading-spinner"></span>
                <span style="font-size:12px; color:var(--text-dim); margin-left:8px;">Gemini ç”Ÿæˆä¸­...</span>
            </div>
            <div id="aiGenerateNoKey" class="hidden" style="font-size:12px; color:var(--text-dim); text-align:center; padding:10px;">
                è¯·å…ˆåœ¨ã€ŒæŠ¥å‘Šã€Tab åº•éƒ¨é…ç½® Gemini API Key
            </div>
        </div>
    </div>

    <!-- TAB 2: BROWSE -->
    <div class="tab-content" id="tab-browse">
        <div class="category-pills" id="browseCategoryPills"></div>
        <div class="card" style="padding:0; overflow:hidden;">
            <div id="wordListContainer"></div>
        </div>
    </div>

    <!-- TAB 3: CHALLENGE -->
    <div class="tab-content" id="tab-challenge">
        <div class="card" id="challengeIntro">
            <div style="text-align:center; padding:20px 0;">
                <div style="font-size:36px; margin-bottom:12px;">ğŸ¯</div>
                <div class="section-title">é™æ—¶æŒ‘æˆ˜</div>
                <p style="font-size:13px; color:var(--text-secondary); margin-bottom:6px;">60ç§’å†…å°½å¯èƒ½å¤šåœ°æ­£ç¡®å‘éŸ³</p>
                <p style="font-size:12px; color:var(--text-dim); margin-bottom:20px;">ä¼˜å…ˆä»æ˜“é”™è¯æ± æŠ½é¢˜</p>
                <button class="next-btn" id="startChallengeBtn" style="max-width:200px; margin:0 auto;">å¼€å§‹æŒ‘æˆ˜</button>
            </div>
        </div>

        <div class="hidden" id="challengeActive">
            <div class="challenge-timer" id="challengeTimer">60</div>
            <div class="challenge-progress" id="challengeProgress">ç¬¬ 0 / 0 é¢˜</div>
            <div class="streak-display">
                <div class="streak-count" id="streakCount">0</div>
                <div class="streak-label">è¿å‡»</div>
            </div>
            <div class="card">
                <div class="word-hero">
                    <div class="word" id="challengeWord">â€”</div>
                    <div class="phonetic" id="challengePhonetic"></div>
                </div>
            </div>
            <div class="record-area">
                <button class="record-btn" id="challengeRecordBtn">
                    <svg class="mic-icon" viewBox="0 0 24 24">
                        <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm-1-9c0-.55.45-1 1-1s1 .45 1 1v6c0 .55-.45 1-1 1s-1-.45-1-1V5z"/>
                        <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
                    </svg>
                </button>
                <div class="record-hint" id="challengeRecordHint">ç‚¹å‡»å½•éŸ³</div>
            </div>
            <div class="feedback-panel" id="challengeFeedback">
                <div class="feedback-score" id="challengeFeedbackScore">â€”</div>
                <div class="recognized-text" id="challengeRecognizedText"></div>
            </div>
        </div>

        <div class="hidden" id="challengeResult">
            <div class="card" style="text-align:center; padding:30px 20px;">
                <div style="font-size:36px; margin-bottom:8px;">ğŸ†</div>
                <div style="font-size:14px; color:var(--text-secondary); margin-bottom:16px;">æŒ‘æˆ˜ç»“æŸ</div>
                <div class="stat-grid">
                    <div class="stat-box"><div class="stat-value" id="resultCorrect">0</div><div class="stat-label">æ­£ç¡®</div></div>
                    <div class="stat-box"><div class="stat-value" id="resultTotal">0</div><div class="stat-label">æ€»é¢˜æ•°</div></div>
                    <div class="stat-box"><div class="stat-value" id="resultAccuracy">0%</div><div class="stat-label">å‡†ç¡®ç‡</div></div>
                    <div class="stat-box"><div class="stat-value" id="resultBestStreak">0</div><div class="stat-label">æœ€é•¿è¿å‡»</div></div>
                </div>
                <button class="next-btn" id="retryChallengeBtn">å†æ¥ä¸€æ¬¡</button>
            </div>
        </div>
    </div>

    <!-- TAB 4: REPORT -->
    <div class="tab-content" id="tab-report">
        <div class="stat-grid" id="reportStats"></div>
        <div class="card">
            <div class="card-title">å‘éŸ³ä¹ æƒ¯åˆ†æ</div>
            <div id="habitAnalysis">
                <div class="empty-state"><div class="emoji">ğŸ“Š</div><p>ç»ƒä¹ æ›´å¤šè¯æ±‡å<br/>è¿™é‡Œä¼šæ˜¾ç¤ºä½ çš„å‘éŸ³ä¹ æƒ¯æ€»ç»“</p></div>
            </div>
        </div>
        <div class="card">
            <div class="card-title">æ˜“é”™è¯ TOP 10</div>
            <div id="troubleList">
                <div class="empty-state"><div class="emoji">ğŸ¯</div><p>è¿˜æ²¡æœ‰æ˜“é”™è¯æ•°æ®</p></div>
            </div>
        </div>
        <div class="card">
            <div class="card-title">å„ç±»åˆ«æ­£ç¡®ç‡</div>
            <div id="categoryAccuracy"></div>
        </div>

        <div class="divider"></div>
        <div class="card">
            <div class="card-title">è®¾ç½®</div>

            <div class="api-config">
                <div style="font-size:13px; color:var(--text-secondary); margin-bottom:4px;">Gemini API Key</div>
                <div style="font-size:11px; color:var(--text-dim); margin-bottom:8px;">å¡«å…¥åå¯ç”¨AIå‘éŸ³è¯„ä¼°ï¼ˆéŸ³ç´ çº§ç²¾åº¦ï¼‰Â· ä¸å¡«åˆ™ç”¨æµè§ˆå™¨è¯­éŸ³è¯†åˆ«</div>
                <div class="api-input-group">
                    <input type="password" class="api-input" id="geminiKeyInput" placeholder="AIza...">
                    <button class="api-save-btn" id="geminiSaveBtn">ä¿å­˜</button>
                </div>
                <div style="margin-top:6px;">
                    <div style="font-size:11px; color:var(--text-dim); margin-bottom:4px;">æ¨¡å‹é€‰æ‹©</div>
                    <select class="model-select" id="geminiModelSelect">
                        <option value="gemini-2.5-flash">gemini-2.5-flashï¼ˆæ¨èÂ·å¿«+å‡†ï¼‰</option>
                        <option value="gemini-2.5-pro">gemini-2.5-proï¼ˆæ›´ç²¾å‡†Â·è¾ƒæ…¢ï¼‰</option>
                        <option value="gemini-2.0-flash">gemini-2.0-flashï¼ˆæ—§ç‰ˆÂ·æœ€å¿«ï¼‰</option>
                    </select>
                </div>
                <div class="api-status" id="geminiStatus">æœªé…ç½® â€” ä½¿ç”¨æµè§ˆå™¨è¯­éŸ³è¯†åˆ«</div>
            </div>

            <div class="config-row">
                <div><div class="config-label">TTS è¯­éŸ³</div><div class="config-sublabel">æ ‡å‡†å‘éŸ³çš„å£éŸ³</div></div>
                <select class="config-input" id="voiceSelect">
                    <option value="en-US">ç¾å¼</option>
                    <option value="en-GB">è‹±å¼</option>
                </select>
            </div>
            <div class="config-row">
                <div><div class="config-label">æŒæ¡é˜ˆå€¼</div><div class="config-sublabel">è¿ç»­æ­£ç¡®æ¬¡æ•°</div></div>
                <input type="number" class="config-input" id="masteryThreshold" value="5" min="2" max="20">
            </div>
            <div class="config-row">
                <div><div class="config-label">é‡ç½®è¿›åº¦</div><div class="config-sublabel">æ¸…é™¤æ‰€æœ‰ç»ƒä¹ æ•°æ®</div></div>
                <button class="api-save-btn" id="resetBtn" style="background:var(--red);">é‡ç½®</button>
            </div>
        </div>
    </div>
</div>

<script>
// ===================================================================
// WORD DATABASE
// ===================================================================
const WORD_DB = [
    // théŸ³
    { word:"think", ipa:"/Î¸ÉªÅ‹k/", zh:"æƒ³ï¼Œè®¤ä¸º", cat:"théŸ³", tip:"èˆŒå°–æ”¾åœ¨ä¸Šä¸‹é½¿ä¹‹é—´ï¼Œè½»è½»å¹æ°”å‘ thã€‚ä¸­å›½äººå¸¸é”™å‘æˆ /s/ æˆ– /f/ã€‚", confuse:"s/f" },
    { word:"three", ipa:"/Î¸riË/", zh:"ä¸‰", cat:"théŸ³", tip:"th + r è¿è¯»ï¼ŒèˆŒå°–å…ˆæ”¾é½¿é—´å†å·èˆŒã€‚åˆ«è¯´æˆ 'sree'ã€‚", confuse:"s/f" },
    { word:"thought", ipa:"/Î¸É”Ët/", zh:"æƒ³æ³•", cat:"théŸ³", tip:"thå¼€å¤´ï¼ŒèˆŒå°–æ”¾é½¿é—´é€æ°”ã€‚ä¸æ˜¯ /sÉ”Ët/ã€‚", confuse:"s" },
    { word:"this", ipa:"/Ã°Éªs/", zh:"è¿™ä¸ª", cat:"théŸ³", tip:"æµŠéŸ³ Ã°ï¼ŒèˆŒå°–é½¿é—´ä½†å£°å¸¦æŒ¯åŠ¨ã€‚ä¸æ˜¯ /dÉªs/ã€‚", confuse:"d/z" },
    { word:"that", ipa:"/Ã°Ã¦t/", zh:"é‚£ä¸ª", cat:"théŸ³", tip:"æµŠéŸ³ Ã° å¼€å¤´ï¼Œå£°å¸¦è¦æŒ¯åŠ¨ã€‚", confuse:"d" },
    { word:"the", ipa:"/Ã°É™/", zh:"å®šå† è¯", cat:"théŸ³", tip:"æœ€å¸¸è§çš„è¯ï¼ŒæµŠéŸ³ Ã°ã€‚èˆŒå°–è¦ç¢°åˆ°ä¸Šé½¿ã€‚", confuse:"d/z" },
    { word:"math", ipa:"/mÃ¦Î¸/", zh:"æ•°å­¦", cat:"théŸ³", tip:"ç»“å°¾ th è¦å’¬èˆŒï¼Œä¸èƒ½åæ‰æˆ–å‘æˆ /s/ã€‚", confuse:"s" },
    { word:"breathe", ipa:"/briËÃ°/", zh:"å‘¼å¸", cat:"théŸ³", tip:"ç»“å°¾æµŠéŸ³ Ã°ã€‚æ³¨æ„å’Œ breath /breÎ¸/ åŒºåˆ†ã€‚", confuse:"d/z" },

    // r/l
    { word:"right", ipa:"/raÉªt/", zh:"å¯¹ï¼›å³", cat:"r/l", tip:"réŸ³ï¼šèˆŒå¤´ä¸ç¢°ä»»ä½•åœ°æ–¹ï¼Œå·å‘ä¸Šæ–¹ã€‚", confuse:"l" },
    { word:"light", ipa:"/laÉªt/", zh:"å…‰ï¼›è½»çš„", cat:"r/l", tip:"léŸ³ï¼šèˆŒå°–æŠµä¸Šé½¿é¾ˆã€‚å’Œ right æ„æˆæœ€å°å¯¹ã€‚", confuse:"r" },
    { word:"really", ipa:"/ËˆriËÉ™li/", zh:"çœŸçš„", cat:"r/l", tip:"å¼€å¤´rç»“å°¾lyï¼Œä¸¤ç§èˆŒä½è¦åœ¨ä¸€ä¸ªè¯å†…åˆ‡æ¢ã€‚", confuse:"l" },
    { word:"world", ipa:"/wÉœËrld/", zh:"ä¸–ç•Œ", cat:"r/l", tip:"rå’Œlç´§æŒ¨ï¼Œå˜´å”‡åœ†èµ·å‘wråèˆŒå°–ç¢°é½¿é¾ˆå‘ldã€‚", confuse:"â€“" },
    { word:"girl", ipa:"/É¡ÉœËrl/", zh:"å¥³å­©", cat:"r/l", tip:"ä¸­é—´rå·èˆŒï¼Œç»“å°¾lèˆŒå°–ç¢°é½¿é¾ˆã€‚ä¸¤ä¸ªéŸ³ä¸èƒ½æ··ã€‚", confuse:"â€“" },
    { word:"role", ipa:"/roÊŠl/", zh:"è§’è‰²", cat:"r/l", tip:"rå¼€å¤´lç»“å°¾ï¼Œå˜´å‹ä»ä¸æ¥è§¦åˆ°æ¥è§¦ä¸Šé½¿é¾ˆã€‚", confuse:"â€“" },
    { word:"parallel", ipa:"/ËˆpÃ¦rÉ™lel/", zh:"å¹³è¡Œçš„", cat:"r/l", tip:"rå’Œläº¤æ›¿å‡ºç°ï¼Œç»ƒå˜´å·´å¿«é€Ÿåˆ‡æ¢ã€‚", confuse:"â€“" },

    // v/w
    { word:"very", ipa:"/Ëˆveri/", zh:"éå¸¸", cat:"v/w", tip:"ä¸Šé½¿å’¬ä¸‹å”‡å‘ vã€‚ä¸­å›½äººå¸¸è¯´æˆ 'wery'ã€‚", confuse:"w" },
    { word:"vest", ipa:"/vest/", zh:"èƒŒå¿ƒ", cat:"v/w", tip:"vï¼šä¸Šé½¿è½»ç¢°ä¸‹å”‡ã€‚å¯¹æ¯” west /west/ã€‚", confuse:"w" },
    { word:"vine", ipa:"/vaÉªn/", zh:"è—¤è”“", cat:"v/w", tip:"v å¼€å¤´ï¼Œä¸Šé½¿ç¢°ä¸‹å”‡ã€‚wine æ˜¯åŒå”‡åœ†èµ·ã€‚", confuse:"w" },
    { word:"vet", ipa:"/vet/", zh:"å…½åŒ»", cat:"v/w", tip:"å’Œ wet å¯¹æ¯”ã€‚vè¦å’¬å”‡ï¼Œwè¦åœ†å”‡ã€‚", confuse:"w" },
    { word:"wave", ipa:"/weÉªv/", zh:"æ³¢æµª", cat:"v/w", tip:"wå¼€å¤´vç»“å°¾ã€‚å¼€å§‹åœ†å”‡ï¼Œç»“å°¾å’¬å”‡ã€‚", confuse:"â€“" },
    { word:"review", ipa:"/rÉªËˆvjuË/", zh:"å¤ä¹ ï¼›è¯„è®º", cat:"v/w", tip:"ä¸­é—´vè¦ä¸Šé½¿ç¢°ä¸‹å”‡ï¼Œä¸èƒ½ç”¨wä»£æ›¿ã€‚", confuse:"w" },

    // å…ƒéŸ³
    { word:"ship", ipa:"/ÊƒÉªp/", zh:"èˆ¹", cat:"å…ƒéŸ³", tip:"çŸ­å…ƒéŸ³ /Éª/ï¼Œå˜´å¾®å¼ ã€‚å’Œ sheep å¯¹æ¯”ã€‚", confuse:"iË" },
    { word:"sheep", ipa:"/ÊƒiËp/", zh:"ç»µç¾Š", cat:"å…ƒéŸ³", tip:"é•¿å…ƒéŸ³ /iË/ï¼Œå˜´è§’æ‹‰å¼€ã€‚å’Œ ship å¯¹æ¯”ã€‚", confuse:"Éª" },
    { word:"bed", ipa:"/bed/", zh:"åºŠ", cat:"å…ƒéŸ³", tip:"çŸ­å…ƒéŸ³ /e/ï¼Œå˜´åŠå¼€ã€‚å’Œ bad å¯¹æ¯”ã€‚", confuse:"Ã¦" },
    { word:"bad", ipa:"/bÃ¦d/", zh:"åçš„", cat:"å…ƒéŸ³", tip:"/Ã¦/ å˜´å¤§å¼ ï¼ŒèˆŒå¤´æ”¾ä½ã€‚å¸¸è¯»æˆ /e/ æˆ– /É‘/ã€‚", confuse:"e/É‘" },
    { word:"hat", ipa:"/hÃ¦t/", zh:"å¸½å­", cat:"å…ƒéŸ³", tip:"/Ã¦/ å˜´è¦å¤§å¼ ï¼Œä¸‹å·´æ”¾ä¸‹æ¥ã€‚ä¸æ˜¯ /het/ã€‚", confuse:"e" },
    { word:"hot", ipa:"/hÉ‘Ët/", zh:"çƒ­çš„", cat:"å…ƒéŸ³", tip:"ç¾å¼ /É‘Ë/ï¼Œå˜´å¤§å¼ åœ†èµ·ã€‚å’Œ hat å¯¹æ¯”ã€‚", confuse:"Ã¦" },
    { word:"full", ipa:"/fÊŠl/", zh:"æ»¡çš„", cat:"å…ƒéŸ³", tip:"çŸ­ /ÊŠ/ï¼Œå˜´å¾®åœ†ã€‚å’Œ fool çš„é•¿ /uË/ å¯¹æ¯”ã€‚", confuse:"uË" },
    { word:"fool", ipa:"/fuËl/", zh:"å‚»ç“œ", cat:"å…ƒéŸ³", tip:"é•¿ /uË/ï¼Œå˜´å”‡åœ†èµ·å‰ä¼¸ã€‚å’Œ full å¯¹æ¯”ã€‚", confuse:"ÊŠ" },
    { word:"cat", ipa:"/kÃ¦t/", zh:"çŒ«", cat:"å…ƒéŸ³", tip:"/Ã¦/ å˜´å¼ å¤§ã€‚ä¸­å›½äººå¸¸è¯»æˆã€Œå‡¯ã€çš„å…ƒéŸ³ã€‚", confuse:"e" },
    { word:"cut", ipa:"/kÊŒt/", zh:"åˆ‡", cat:"å…ƒéŸ³", tip:"/ÊŒ/ å˜´åŠå¼€ï¼ŒçŸ­ä¿ƒæœ‰åŠ›ã€‚åƒã€Œå•Šã€ä½†æ›´çŸ­ã€‚", confuse:"É‘" },

    // å°¾éŸ³
    { word:"walked", ipa:"/wÉ”Ëkt/", zh:"èµ°ï¼ˆè¿‡å»å¼ï¼‰", cat:"å°¾éŸ³", tip:"-ed åœ¨æ¸…è¾…éŸ³åè¯» /t/ã€‚ä¸è¦è¯»æˆä¸¤ä¸ªéŸ³èŠ‚ã€‚", confuse:"Éªd" },
    { word:"played", ipa:"/pleÉªd/", zh:"ç©ï¼ˆè¿‡å»å¼ï¼‰", cat:"å°¾éŸ³", tip:"-ed åœ¨æµŠéŸ³åè¯» /d/ã€‚åªåŠ ä¸€ä¸ª /d/ã€‚", confuse:"Éªd" },
    { word:"wanted", ipa:"/ËˆwÉ‘ËntÉªd/", zh:"æƒ³è¦ï¼ˆè¿‡å»å¼ï¼‰", cat:"å°¾éŸ³", tip:"-ed åœ¨ t/d åè¯» /Éªd/ï¼Œå¤šä¸€ä¸ªéŸ³èŠ‚ã€‚", confuse:"t/d" },
    { word:"watched", ipa:"/wÉ‘ËtÊƒt/", zh:"çœ‹ï¼ˆè¿‡å»å¼ï¼‰", cat:"å°¾éŸ³", tip:"-ed è¯» /t/ï¼Œä¸æ˜¯ /Éªd/ã€‚", confuse:"Éªd" },
    { word:"called", ipa:"/kÉ”Ëld/", zh:"æ‰“ç”µè¯ï¼ˆè¿‡å»å¼ï¼‰", cat:"å°¾éŸ³", tip:"-ed è¯» /d/ã€‚ä¸è¦åæ‰å°¾éŸ³ã€‚", confuse:"â€“" },
    { word:"needed", ipa:"/ËˆniËdÉªd/", zh:"éœ€è¦ï¼ˆè¿‡å»å¼ï¼‰", cat:"å°¾éŸ³", tip:"-ed åœ¨ d åè¯» /Éªd/ï¼Œä¸¤ä¸ªéŸ³èŠ‚ã€‚", confuse:"d" },
    { word:"stopped", ipa:"/stÉ‘Ëpt/", zh:"åœæ­¢ï¼ˆè¿‡å»å¼ï¼‰", cat:"å°¾éŸ³", tip:"-ed åœ¨ p åè¯» /t/ã€‚", confuse:"Éªd" },
    { word:"decided", ipa:"/dÉªËˆsaÉªdÉªd/", zh:"å†³å®šï¼ˆè¿‡å»å¼ï¼‰", cat:"å°¾éŸ³", tip:"-ed åœ¨ d åè¯» /Éªd/ã€‚", confuse:"d" },
    { word:"cats", ipa:"/kÃ¦ts/", zh:"çŒ«ï¼ˆå¤æ•°ï¼‰", cat:"å°¾éŸ³", tip:"-s åœ¨æ¸…è¾…éŸ³åè¯» /s/ã€‚ä¸èƒ½åæ‰ã€‚", confuse:"â€“" },
    { word:"dogs", ipa:"/dÉ”ËÉ¡z/", zh:"ç‹—ï¼ˆå¤æ•°ï¼‰", cat:"å°¾éŸ³", tip:"-s åœ¨æµŠéŸ³åè¯» /z/ã€‚", confuse:"s" },
    { word:"watches", ipa:"/ËˆwÉ‘ËtÊƒÉªz/", zh:"æ‰‹è¡¨ï¼ˆå¤æ•°ï¼‰", cat:"å°¾éŸ³", tip:"-es åœ¨ sh/ch/s/x åè¯» /Éªz/ã€‚", confuse:"â€“" },
    { word:"months", ipa:"/mÊŒnÎ¸s/", zh:"æœˆï¼ˆå¤æ•°ï¼‰", cat:"å°¾éŸ³", tip:"th + s è¿è¯»ï¼Œå…¬è®¤æœ€éš¾å‘çš„è¯ä¹‹ä¸€ã€‚", confuse:"â€“" },

    // é‡éŸ³
    { word:"record", ipa:"/ËˆrekÉ”Ërd/", zh:"åè¯ï¼šè®°å½•", cat:"é‡éŸ³", tip:"åè¯é‡éŸ³åœ¨å‰ã€‚åŠ¨è¯é‡éŸ³åœ¨å /rÉªËˆkÉ”Ërd/ã€‚", confuse:"â€“" },
    { word:"desert", ipa:"/ËˆdezÉ™rt/", zh:"æ²™æ¼ ", cat:"é‡éŸ³", tip:"æ²™æ¼ é‡éŸ³åœ¨å‰ã€‚ç”œç‚¹ dessert é‡éŸ³åœ¨åã€‚", confuse:"â€“" },
    { word:"present", ipa:"/ËˆprezÉ™nt/", zh:"åè¯ï¼šç¤¼ç‰©", cat:"é‡éŸ³", tip:"åè¯é‡éŸ³åœ¨å‰ï¼ŒåŠ¨è¯é‡éŸ³åœ¨åã€‚", confuse:"â€“" },
    { word:"produce", ipa:"/ËˆprÉ’djuËs/", zh:"åè¯ï¼šå†œäº§å“", cat:"é‡éŸ³", tip:"åè¯é‡éŸ³åœ¨å‰ï¼ŒåŠ¨è¯é‡éŸ³åœ¨åã€‚", confuse:"â€“" },
    { word:"comfortable", ipa:"/ËˆkÊŒmftÉ™bl/", zh:"èˆ’é€‚çš„", cat:"é‡éŸ³", tip:"å®é™…åªè¯»3ä¸ªéŸ³èŠ‚ COMF-ter-bleã€‚", confuse:"â€“" },
    { word:"vegetable", ipa:"/ËˆvedÊ’tÉ™bl/", zh:"è”¬èœ", cat:"é‡éŸ³", tip:"å®é™…åªè¯»3ä¸ªéŸ³èŠ‚ VEJ-tuh-bleã€‚", confuse:"â€“" },
    { word:"interesting", ipa:"/ËˆÉªntrÉ™stÉªÅ‹/", zh:"æœ‰è¶£çš„", cat:"é‡éŸ³", tip:"3ä¸ªéŸ³èŠ‚ IN-tres-tingï¼Œä¸­é—´eä¸å‘éŸ³ã€‚", confuse:"â€“" },

    // ç‰¹æ®Š
    { word:"usually", ipa:"/ËˆjuËÊ’uÉ™li/", zh:"é€šå¸¸", cat:"ç‰¹æ®Š", tip:"ä¸­é—´ /Ê’/ éŸ³ï¼Œåƒæ³•è¯­çš„ jã€‚", confuse:"s" },
    { word:"measure", ipa:"/ËˆmeÊ’É™r/", zh:"æµ‹é‡", cat:"ç‰¹æ®Š", tip:"ä¸­é—´ /Ê’/ éŸ³ï¼Œå£°å¸¦æŒ¯åŠ¨çš„ shã€‚", confuse:"s" },
    { word:"genre", ipa:"/ËˆÊ’É‘ËnrÉ™/", zh:"ç±»å‹", cat:"ç‰¹æ®Š", tip:"å¼€å¤´æ˜¯ /Ê’/ï¼Œæ³•è¯­å€Ÿè¯ã€‚", confuse:"dÊ’" },
    { word:"architecture", ipa:"/ËˆÉ‘ËrkÉªtektÊƒÉ™r/", zh:"å»ºç­‘", cat:"ç‰¹æ®Š", tip:"ch è¯» /k/ ä¸è¯» /tÊƒ/ã€‚", confuse:"tÊƒ" },
    { word:"choir", ipa:"/kwaÉªÉ™r/", zh:"åˆå”±å›¢", cat:"ç‰¹æ®Š", tip:"è¯» kwireï¼Œchå‘/k/ã€‚", confuse:"tÊƒ" },
    { word:"recipe", ipa:"/ËˆresÉªpi/", zh:"é£Ÿè°±", cat:"ç‰¹æ®Š", tip:"3éŸ³èŠ‚ RE-si-peeã€‚ç»“å°¾è¯» /pi/ã€‚", confuse:"â€“" },
    { word:"colonel", ipa:"/ËˆkÉœËrnl/", zh:"ä¸Šæ ¡", cat:"ç‰¹æ®Š", tip:"æ‹¼å†™å’Œå‘éŸ³å®Œå…¨ä¸åŒï¼è¯» kernelã€‚", confuse:"â€“" },
    { word:"determine", ipa:"/dÉªËˆtÉœËrmÉªn/", zh:"å†³å®š", cat:"ç‰¹æ®Š", tip:"-mine è¯» /mÉªn/ ä¸æ˜¯ /maÉªn/ã€‚", confuse:"â€“" },

    // n/Å‹
    { word:"thin", ipa:"/Î¸Éªn/", zh:"è–„çš„", cat:"n/Å‹", tip:"ç»“å°¾ /n/ï¼ŒèˆŒå°–ç¢°é½¿é¾ˆã€‚å’Œ thing å¯¹æ¯”ã€‚", confuse:"Å‹" },
    { word:"thing", ipa:"/Î¸ÉªÅ‹/", zh:"ä¸œè¥¿", cat:"n/Å‹", tip:"ç»“å°¾ /Å‹/ï¼ŒèˆŒæ ¹ç¢°è½¯è…­ã€‚ä¸å¸¦ /É¡/ã€‚", confuse:"n/Å‹É¡" },
    { word:"sing", ipa:"/sÉªÅ‹/", zh:"å”±æ­Œ", cat:"n/Å‹", tip:"/Å‹/ ç»“å°¾ï¼Œåé¢ä¸è¦åŠ  /É¡/ã€‚", confuse:"Å‹É¡" },
    { word:"singer", ipa:"/ËˆsÉªÅ‹É™r/", zh:"æ­Œæ‰‹", cat:"n/Å‹", tip:"sing+erï¼Œä¸­é—´ä¸åŠ  /É¡/ã€‚", confuse:"Å‹É¡" },
    { word:"finger", ipa:"/ËˆfÉªÅ‹É¡É™r/", zh:"æ‰‹æŒ‡", cat:"n/Å‹", tip:"è¿™ä¸ªè¯é‡Œ ng ç¡®å®è¯» /Å‹É¡/ã€‚å’Œ singer å¯¹æ¯”ã€‚", confuse:"Å‹" },

    // çŸ­å¥ â€” è¿è¯»
    { word:"pick it up", ipa:"/ËŒpÉªk Éªt ËˆÊŒp/", zh:"æ¡èµ·æ¥", cat:"è¿è¯»", tip:"ä¸‰ä¸ªè¯è¿æˆä¸€ç‰‡ï¼špickit-upã€‚kå’Œiè¿è¯»ï¼Œtå’Œuè¿è¯»ã€‚", confuse:"â€“" },
    { word:"not at all", ipa:"/ËŒnÉ‘Ët É™t ËˆÉ”Ël/", zh:"ä¸€ç‚¹ä¹Ÿä¸", cat:"è¿è¯»", tip:"notâ€¿atâ€¿all ä¸‰è¿è¯»ï¼Œtåœ¨å…ƒéŸ³å‰å¼¹èˆŒå˜è½»å¼¹éŸ³ã€‚", confuse:"â€“" },
    { word:"kind of", ipa:"/ËˆkaÉªndÉ™v/", zh:"æœ‰ç‚¹", cat:"è¿è¯»", tip:"å£è¯­ä¸­è¯» kinda /ËˆkaÉªndÉ™/ï¼Œofå¼±åŒ–ä¸º /É™v/ æˆ–æ¶ˆå¤±ã€‚", confuse:"â€“" },
    { word:"want to", ipa:"/ËˆwÉ‘ËntÉ™/", zh:"æƒ³è¦", cat:"è¿è¯»", tip:"å£è¯­ä¸­è¯» wannaã€‚tè¢«åŒåŒ–ï¼Œtoå¼±è¯»ä¸º /tÉ™/ æˆ–æ¶ˆå¤±ã€‚", confuse:"â€“" },
    { word:"going to", ipa:"/ËˆÉ¡É”ËnÉ™/", zh:"å°†è¦", cat:"è¿è¯»", tip:"å£è¯­è¯» gonnaã€‚-ing to æ•´ä½“å¼±åŒ–ã€‚", confuse:"â€“" },
    { word:"let me", ipa:"/Ëˆlemmi/", zh:"è®©æˆ‘", cat:"è¿è¯»", tip:"å£è¯­è¯» lemmeã€‚tè¢«måŒåŒ–ã€‚", confuse:"â€“" },
    { word:"give me", ipa:"/ËˆÉ¡Éªmmi/", zh:"ç»™æˆ‘", cat:"è¿è¯»", tip:"å£è¯­è¯» gimmeã€‚vè¢«måŒåŒ–ã€‚", confuse:"â€“" },
    { word:"a lot of", ipa:"/É™ ËˆlÉ‘Ët É™v/", zh:"å¾ˆå¤š", cat:"è¿è¯»", tip:"aå¼±è¯»ï¼Œlotâ€¿ofè¿è¯»ï¼Œofè¯» /É™v/ã€‚æ•´ä½“åƒ uh-lottaã€‚", confuse:"â€“" },

    // çŸ­å¥ â€” å¼±è¯»
    { word:"a cup of tea", ipa:"/É™ ËŒkÊŒp É™v ËˆtiË/", zh:"ä¸€æ¯èŒ¶", cat:"å¼±è¯»", tip:"aå’Œoféƒ½å¼±è¯»ä¸º /É™/ã€‚é‡éŸ³åªåœ¨cupå’Œteaä¸Šã€‚", confuse:"â€“" },
    { word:"I want to go", ipa:"/aÉª ËŒwÉ‘ËnÉ™ ËˆÉ¡oÊŠ/", zh:"æˆ‘æƒ³èµ°", cat:"å¼±è¯»", tip:"want toå¼±è¯»ä¸º wannaï¼Œé‡éŸ³åœ¨goã€‚", confuse:"â€“" },
    { word:"he can do it", ipa:"/hi kÉ™n ËˆduË Éªt/", zh:"ä»–èƒ½åšåˆ°", cat:"å¼±è¯»", tip:"canå¼±è¯»ä¸º /kÉ™n/ã€‚åªæœ‰å¦å®š can't æ‰é‡è¯»ã€‚", confuse:"â€“" },
    { word:"what do you think", ipa:"/ËŒwÊŒdÉ™ jÉ™ ËˆÎ¸ÉªÅ‹k/", zh:"ä½ è§‰å¾—å‘¢", cat:"å¼±è¯»", tip:"doå¼±è¯»ï¼Œyouå¼±è¯»ä¸º /jÉ™/ï¼Œwhatçš„tå¼¹èˆŒã€‚æ³¨æ„thinkçš„thã€‚", confuse:"â€“" },
    { word:"I should have gone", ipa:"/aÉª ËŒÊƒÊŠdÉ™v ËˆÉ¡É”Ën/", zh:"æˆ‘æœ¬åº”è¯¥å»çš„", cat:"å¼±è¯»", tip:"should haveè¯» shoulda/shoulduvã€‚haveå¼±è¯»ä¸º /É™v/ã€‚", confuse:"â€“" },
    { word:"some of them", ipa:"/ËŒsÊŒm É™v Ã°É™m/", zh:"ä»–ä»¬ä¸­çš„ä¸€äº›", cat:"å¼±è¯»", tip:"ofå¼±è¯»ï¼Œthemå¼±è¯»ä¸º /Ã°É™m/ã€‚æ³¨æ„thæµŠéŸ³ã€‚", confuse:"â€“" },

    // çŸ­å¥ â€” théŸ³åœ¨å¥ä¸­
    { word:"Is this the one", ipa:"/Éªz ËŒÃ°Éªs Ã°É™ ËˆwÊŒn/", zh:"æ˜¯è¿™ä¸ªå—", cat:"å¥ä¸­th", tip:"è¿ç»­ä¸¤ä¸ª Ã° éŸ³ã€‚thisâ€¿the èˆŒå¤´è¦ä¸€ç›´ä¿æŒåœ¨é½¿é—´ã€‚", confuse:"â€“" },
    { word:"I think that's right", ipa:"/aÉª ËŒÎ¸ÉªÅ‹k Ã°Ã¦ts ËˆraÉªt/", zh:"æˆ‘è§‰å¾—å¯¹", cat:"å¥ä¸­th", tip:"ä¸€å¥è¯é‡Œæœ‰ Î¸ å’Œ Ã° ä¸¤ç§thã€‚thinkæ¸…éŸ³ï¼Œthat'sæµŠéŸ³ã€‚", confuse:"â€“" },
    { word:"the other thing", ipa:"/Ã°É™ ËŒÊŒÃ°É™r ËˆÎ¸ÉªÅ‹/", zh:"å¦ä¸€ä¸ªä¸œè¥¿", cat:"å¥ä¸­th", tip:"ä¸‰ä¸ªthï¼the(Ã°) + other(Ã°) + thing(Î¸)ã€‚æå¥½çš„thå¯†é›†è®­ç»ƒã€‚", confuse:"â€“" },
    { word:"that's the truth", ipa:"/ËŒÃ°Ã¦ts Ã°É™ ËˆtruËÎ¸/", zh:"é‚£æ˜¯äº‹å®", cat:"å¥ä¸­th", tip:"å¼€å¤´that'sæµŠéŸ³Ã°ï¼Œç»“å°¾truthæ¸…éŸ³Î¸ã€‚", confuse:"â€“" },
    { word:"both of them", ipa:"/ËŒboÊŠÎ¸ É™v ËˆÃ°em/", zh:"ä»–ä»¬ä¸¤ä¸ªéƒ½", cat:"å¥ä¸­th", tip:"bothç»“å°¾Î¸ï¼Œthemå¼€å¤´Ã°ã€‚æ¸…æµŠåˆ‡æ¢ã€‚", confuse:"â€“" },

    // çŸ­å¥ â€” r/låœ¨å¥ä¸­
    { word:"really long road", ipa:"/ËˆriËÉ™li ËŒlÉ”ËÅ‹ ËˆroÊŠd/", zh:"éå¸¸é•¿çš„è·¯", cat:"å¥ä¸­r/l", tip:"r-l-räº¤æ›¿è½°ç‚¸ã€‚èˆŒå¤´å¿…é¡»åœ¨ä¸¤ä¸ªä½ç½®é—´å¿«é€Ÿåˆ‡æ¢ã€‚", confuse:"â€“" },
    { word:"I'll be right back", ipa:"/aÉªl bi ËŒraÉªt ËˆbÃ¦k/", zh:"æˆ‘é©¬ä¸Šå›æ¥", cat:"å¥ä¸­r/l", tip:"I'llçš„dark l + rightçš„rã€‚æ³¨æ„lå’Œrçš„åŒºåˆ«ã€‚", confuse:"â€“" },
    { word:"real or virtual", ipa:"/ËŒriËÉ™l É”Ër ËˆvÉœËrtÊƒuÉ™l/", zh:"çœŸå®çš„è¿˜æ˜¯è™šæ‹Ÿçš„", cat:"å¥ä¸­r/l", tip:"rå’Œlé«˜é¢‘åˆ‡æ¢ï¼ŒåŠ ä¸ŠvéŸ³ã€‚ç»¼åˆè®­ç»ƒã€‚", confuse:"â€“" },

    // çŸ­å¥ â€” èŠ‚å¥ä¸è¯­è°ƒ
    { word:"What are you doing", ipa:"/ËŒwÊŒt É‘Ër jÉ™ ËˆduËÉªÅ‹/", zh:"ä½ åœ¨å¹²ä»€ä¹ˆ", cat:"èŠ‚å¥", tip:"Whç–‘é—®å¥é™è°ƒã€‚areå¼±è¯»ï¼Œyouå¼±è¯»ä¸º /jÉ™/ã€‚", confuse:"â€“" },
    { word:"I don't know", ipa:"/aÉª ËŒdoÊŠnt ËˆnoÊŠ/", zh:"æˆ‘ä¸çŸ¥é“", cat:"èŠ‚å¥", tip:"å£è¯­å¸¸è¯» I dunnoã€‚é‡éŸ³åœ¨knowã€‚", confuse:"â€“" },
    { word:"Could you say that again", ipa:"/kÊŠd jÉ™ ËŒseÉª Ã°Ã¦t É™ËˆÉ¡en/", zh:"ä½ èƒ½å†è¯´ä¸€éå—", cat:"èŠ‚å¥", tip:"å‡è°ƒï¼ˆè¯·æ±‚ï¼‰ã€‚couldå¼±è¯»ï¼Œyouå¼±è¯»ï¼Œthatæœ‰thã€‚", confuse:"â€“" },
    { word:"It doesn't matter", ipa:"/Éªt ËŒdÊŒznt ËˆmÃ¦tÉ™r/", zh:"æ²¡å…³ç³»", cat:"èŠ‚å¥", tip:"doesn'tçš„tå¸¸çœç•¥ã€‚matterçš„ttå¼¹èˆŒå˜ /d/ã€‚", confuse:"â€“" },
    { word:"Nice to meet you", ipa:"/ËŒnaÉªs tÉ™ ËˆmiËt jÊŠ/", zh:"å¾ˆé«˜å…´è®¤è¯†ä½ ", cat:"èŠ‚å¥", tip:"toå¼±è¯»ä¸º /tÉ™/ã€‚æ•´å¥èŠ‚å¥ï¼šNICE-tuh-MEET-youã€‚", confuse:"â€“" },
];

// ===================================================================
// APP STATE
// ===================================================================
const STATE = {
    currentIndex: 0, currentCategory: 'all', filteredWords: [],
    speechRate: 1.0, voiceLang: 'en-US', masteryThreshold: 5,
    isRecording: false, recognition: null, mediaRecorder: null, audioChunks: [],
    geminiKey: '', geminiModel: 'gemini-2.5-flash', useGemini: false,
    progress: {},
    challengeActive: false, challengeTimer: null, challengeTimeLeft: 60,
    challengeCorrect: 0, challengeTotal: 0, challengeStreak: 0, challengeBestStreak: 0,
    totalAttempts: 0, totalCorrect: 0,
    isProcessing: false,
};

// ===================================================================
// INIT
// ===================================================================
function init() {
    loadState(); buildCategoryPills(); filterWords();
    showCurrentWord(); setupTabs(); setupRecording(); setupControls();
    renderBrowseList(); renderReport();
}

function loadState() {
    try {
        const saved = localStorage.getItem('pronTrainerV2');
        if (saved) {
            const d = JSON.parse(saved);
            STATE.progress = d.progress || {};
            STATE.totalAttempts = d.totalAttempts || 0;
            STATE.totalCorrect = d.totalCorrect || 0;
            STATE.speechRate = d.speechRate || 1.0;
            STATE.voiceLang = d.voiceLang || 'en-US';
            STATE.masteryThreshold = d.masteryThreshold || 5;
            STATE.geminiKey = d.geminiKey || '';
            STATE.geminiModel = d.geminiModel || 'gemini-2.5-flash';
            STATE.useGemini = !!STATE.geminiKey;
        }
    } catch(e) {}
    document.getElementById('voiceSelect').value = STATE.voiceLang;
    document.getElementById('masteryThreshold').value = STATE.masteryThreshold;
    document.getElementById('speedLabel').textContent = STATE.speechRate.toFixed(1) + 'x';
    document.getElementById('geminiModelSelect').value = STATE.geminiModel;
    if (STATE.geminiKey) {
        document.getElementById('geminiKeyInput').value = 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢';
        document.getElementById('geminiStatus').textContent = 'å·²é…ç½® â€” æ¨¡å‹: ' + STATE.geminiModel;
        document.getElementById('geminiStatus').className = 'api-status connected';
    }
}

function saveState() {
    try {
        localStorage.setItem('pronTrainerV2', JSON.stringify({
            progress: STATE.progress, totalAttempts: STATE.totalAttempts,
            totalCorrect: STATE.totalCorrect, speechRate: STATE.speechRate,
            voiceLang: STATE.voiceLang, masteryThreshold: STATE.masteryThreshold,
            geminiKey: STATE.geminiKey, geminiModel: STATE.geminiModel,
        }));
    } catch(e) {}
}

// ===================================================================
// TABS
// ===================================================================
function setupTabs() {
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
            if (btn.dataset.tab === 'browse') renderBrowseList();
            if (btn.dataset.tab === 'report') renderReport();
        });
    });
}

// ===================================================================
// CATEGORIES
// ===================================================================
function buildCategoryPills() {
    const cats = ['all', ...new Set(WORD_DB.map(w => w.cat))];
    ['trainCategoryPills','browseCategoryPills'].forEach(id => {
        const c = document.getElementById(id);
        c.innerHTML = '';
        cats.forEach(cat => {
            const p = document.createElement('button');
            p.className = 'pill' + (cat === 'all' ? ' active' : '');
            p.textContent = cat === 'all' ? 'å…¨éƒ¨' : cat;
            p.dataset.cat = cat;
            p.addEventListener('click', () => {
                c.querySelectorAll('.pill').forEach(x => x.classList.remove('active'));
                p.classList.add('active');
                STATE.currentCategory = cat;
                filterWords(); STATE.currentIndex = 0;
                showCurrentWord();
                if (id === 'browseCategoryPills') renderBrowseList();
            });
            c.appendChild(p);
        });
    });
}

function filterWords() {
    STATE.filteredWords = STATE.currentCategory === 'all'
        ? [...WORD_DB]
        : WORD_DB.filter(w => w.cat === STATE.currentCategory);
}

// ===================================================================
// WORD DISPLAY
// ===================================================================
function showCurrentWord() {
    if (!STATE.filteredWords.length) return;
    const w = STATE.filteredWords[STATE.currentIndex % STATE.filteredWords.length];
    document.getElementById('heroWord').textContent = w.word;
    document.getElementById('heroPhonetic').textContent = w.ipa;
    document.getElementById('heroTranslation').textContent = w.zh;
    document.getElementById('heroTip').textContent = w.tip;
    const prog = STATE.progress[w.word] || { correct:0, wrong:0, streak:0 };
    const total = prog.correct + prog.wrong;
    document.getElementById('repeatCounter').textContent = `æœ¬è¯ç»ƒä¹  ${total} æ¬¡` +
        (prog.mastered ? ' âœ“ å·²æŒæ¡' : prog.streak > 0 ? ` Â· è¿ç»­æ­£ç¡® ${prog.streak}` : '');
    document.getElementById('feedbackPanel').classList.remove('show');
}

function nextWord() {
    STATE.currentIndex = (STATE.currentIndex + 1) % STATE.filteredWords.length;
    showCurrentWord();
}

// ===================================================================
// TTS
// ===================================================================
function playStandard(word, rate) {
    const u = new SpeechSynthesisUtterance(word || STATE.filteredWords[STATE.currentIndex % STATE.filteredWords.length].word);
    u.lang = STATE.voiceLang;
    u.rate = rate || STATE.speechRate;
    const voices = speechSynthesis.getVoices();
    const pref = voices.find(v => v.lang.startsWith(STATE.voiceLang));
    if (pref) u.voice = pref;
    speechSynthesis.cancel();
    speechSynthesis.speak(u);
}

// ===================================================================
// RECORDING
// ===================================================================
function setupRecording() {
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (SR) {
        STATE.recognition = new SR();
        STATE.recognition.lang = 'en-US';
        STATE.recognition.interimResults = false;
        STATE.recognition.maxAlternatives = 5;
        STATE.recognition.onresult = (e) => {
            const results = [];
            for (let i = 0; i < e.results[0].length; i++) {
                results.push({ text: e.results[0][i].transcript.trim().toLowerCase(), confidence: e.results[0][i].confidence });
            }
            handleBrowserResult(results);
        };
        STATE.recognition.onerror = (e) => {
            stopRecording();
            if (e.error === 'no-speech') showFeedback('wrong','â€”','æ²¡æœ‰æ£€æµ‹åˆ°å£°éŸ³','è¯·é è¿‘éº¦å…‹é£å†è¯•');
        };
        STATE.recognition.onend = () => { if (!STATE.useGemini) stopRecordingUI(); };
    }
}

function startRecording() {
    if (STATE.isProcessing) return;
    if (STATE.isRecording) { stopRecording(); return; }

    STATE.isRecording = true;
    const btn = STATE.challengeActive ? document.getElementById('challengeRecordBtn') : document.getElementById('recordBtn');
    const hint = STATE.challengeActive ? document.getElementById('challengeRecordHint') : document.getElementById('recordHint');
    btn.classList.add('recording');
    hint.textContent = 'æ­£åœ¨å¬...'; hint.classList.add('listening');

    if (STATE.useGemini) {
        startGeminiRecording();
    } else if (STATE.recognition) {
        try { STATE.recognition.start(); } catch(e) { stopRecording(); }
    } else {
        stopRecording();
        showFeedback('wrong','â€”','æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«','è¯·ä½¿ç”¨Chromeå¹¶é…ç½®Gemini API Key');
    }
}

function stopRecording() {
    STATE.isRecording = false;
    stopRecordingUI();
    try { STATE.recognition && STATE.recognition.stop(); } catch(e) {}
    if (STATE.mediaRecorder && STATE.mediaRecorder.state !== 'inactive') STATE.mediaRecorder.stop();
}

function stopRecordingUI() {
    [document.getElementById('recordBtn'), document.getElementById('challengeRecordBtn')].forEach(b => b && b.classList.remove('recording'));
    [document.getElementById('recordHint'), document.getElementById('challengeRecordHint')].forEach(h => {
        if (h) { h.textContent = 'ç‚¹å‡»å¼€å§‹å½•éŸ³'; h.classList.remove('listening'); }
    });
}

// ===================================================================
// GEMINI INTEGRATION
// ===================================================================
async function startGeminiRecording() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        STATE.audioChunks = [];
        STATE.mediaRecorder = new MediaRecorder(stream, {
            mimeType: MediaRecorder.isTypeSupported('audio/webm;codecs=opus') ? 'audio/webm;codecs=opus' : 'audio/webm'
        });
        STATE.mediaRecorder.ondataavailable = (e) => { if (e.data.size > 0) STATE.audioChunks.push(e.data); };
        STATE.mediaRecorder.onstop = async () => {
            stream.getTracks().forEach(t => t.stop());
            const blob = new Blob(STATE.audioChunks, { type: 'audio/webm' });
            STATE.isProcessing = true;
            setHintText('AI åˆ†æä¸­...');
            try {
                await sendToGemini(blob);
            } catch(err) {
                console.error('Gemini error', err);
                showFeedback('wrong','â€”','Gemini è¯·æ±‚å¤±è´¥', err.message);
            }
            STATE.isProcessing = false;
        };
        STATE.mediaRecorder.start();
        setTimeout(() => { if (STATE.isRecording) stopRecording(); }, 5000);
    } catch(err) {
        stopRecording();
        showFeedback('wrong','â€”','æ— æ³•è®¿é—®éº¦å…‹é£','è¯·åœ¨æµè§ˆå™¨è®¾ç½®ä¸­å…è®¸éº¦å…‹é£æƒé™');
    }
}

function setHintText(text) {
    const hint = STATE.challengeActive ? document.getElementById('challengeRecordHint') : document.getElementById('recordHint');
    if (hint) { hint.innerHTML = `<span class="loading-spinner"></span> ${text}`; hint.classList.add('listening'); }
}

async function sendToGemini(audioBlob) {
    const currentWord = STATE.challengeActive
        ? document.getElementById('challengeWord').textContent
        : STATE.filteredWords[STATE.currentIndex % STATE.filteredWords.length].word;

    const wordEntry = WORD_DB.find(w => w.word === currentWord);

    // Convert blob to base64
    const arrayBuf = await audioBlob.arrayBuffer();
    const base64 = btoa(String.fromCharCode(...new Uint8Array(arrayBuf)));

    const prompt = `You are an expert English pronunciation coach for Chinese (Mandarin) speakers.

The student is trying to say: "${currentWord}" (IPA: ${wordEntry?.ipa || ''})
This is ${currentWord.includes(' ') ? 'a phrase/sentence' : 'a single word'}.

Listen to the audio and evaluate their pronunciation. ${currentWord.includes(' ') ? 'Pay attention to connected speech, weak forms, rhythm, and intonation in addition to individual sounds.' : ''}

Respond ONLY with a JSON object, no markdown, no explanation:
{
  "recognized": "what you heard them say",
  "score": 0-100,
  "correct": true/false,
  "phoneme_issues": [
    {"phoneme": "/Î¸/", "problem": "pronounced as /s/", "advice": "èˆŒå°–æ”¾åœ¨é½¿é—´"}
  ],
  "overall_advice": "one sentence advice in Chinese",
  "confidence": 0-1
}

Scoring guide:
- 85-100: Correct and natural
- 60-84: Understandable but with noticeable accent issues
- 30-59: Significant pronunciation errors
- 0-29: Wrong word or unintelligible

${currentWord.includes(' ') ? 'For phrases, also evaluate: connected speech (linking sounds between words), weak forms (unstressed words like a, the, of, to), rhythm (stress-timed pattern), and natural intonation.' : ''}

Be strict but fair. Chinese speakers commonly struggle with: th/s confusion, r/l confusion, v/w confusion, vowel length distinctions, final consonant dropping, -ed endings, connected speech, and weak forms.`;

    const url = `https://generativelanguage.googleapis.com/v1beta/models/${STATE.geminiModel}:generateContent?key=${STATE.geminiKey}`;

    const body = {
        contents: [{
            parts: [
                { text: prompt },
                { inline_data: { mime_type: 'audio/webm', data: base64 } }
            ]
        }],
        generationConfig: {
            temperature: 0.1,
            maxOutputTokens: 500,
        }
    };

    const resp = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body),
    });

    if (!resp.ok) {
        const errData = await resp.json().catch(() => ({}));
        const errMsg = errData.error?.message || `HTTP ${resp.status}`;
        throw new Error(errMsg);
    }

    const data = await resp.json();
    const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';

    // Parse JSON from response (handle markdown code blocks)
    let jsonStr = text;
    const jsonMatch = text.match(/```(?:json)?\s*([\s\S]*?)```/);
    if (jsonMatch) jsonStr = jsonMatch[1];
    jsonStr = jsonStr.trim();

    let result;
    try {
        result = JSON.parse(jsonStr);
    } catch(e) {
        // Try to extract JSON object
        const objMatch = jsonStr.match(/\{[\s\S]*\}/);
        if (objMatch) {
            result = JSON.parse(objMatch[0]);
        } else {
            throw new Error('æ— æ³•è§£æ Gemini è¿”å›: ' + text.substring(0, 100));
        }
    }

    handleGeminiResult(result, currentWord);
}

function handleGeminiResult(result, targetWord) {
    const score = Math.round(result.score || 0);
    const level = score >= 85 ? 'correct' : score >= 60 ? 'partial' : 'wrong';
    const isCorrect = score >= 70;

    recordAttempt(targetWord, isCorrect, result.recognized || '');

    // Build detail text
    let detail = result.overall_advice || '';
    if (result.phoneme_issues && result.phoneme_issues.length > 0) {
        detail += '\n\néŸ³ç´ é—®é¢˜ï¼š';
        result.phoneme_issues.forEach(p => {
            detail += `\nâ€¢ ${p.phoneme}: ${p.problem}`;
            if (p.advice) detail += ` â†’ ${p.advice}`;
        });
    }

    if (STATE.challengeActive) {
        showChallengeFeedback(level, score, result.recognized || '');
    } else {
        showFeedback(level, score, result.recognized || '', detail);
    }
}

// ===================================================================
// BROWSER RECOGNITION FALLBACK
// ===================================================================
function handleBrowserResult(results) {
    const currentWord = STATE.challengeActive
        ? document.getElementById('challengeWord').textContent
        : STATE.filteredWords[STATE.currentIndex % STATE.filteredWords.length].word;
    const target = currentWord.toLowerCase().trim();

    let bestScore = 0, bestText = results[0]?.text || '';
    results.forEach(r => {
        const sim = computeSimilarity(target, r.text.replace(/[^a-z\s]/gi,'').trim());
        if (sim > bestScore) { bestScore = sim; bestText = r.text; }
    });

    const score = Math.round(bestScore * 100);
    const level = score >= 85 ? 'correct' : score >= 60 ? 'partial' : 'wrong';
    recordAttempt(currentWord, score >= 70, bestText);

    if (STATE.challengeActive) {
        showChallengeFeedback(level, score, bestText);
    } else {
        const detail = score >= 85 ? 'å‘éŸ³å‡†ç¡®ï¼' :
            score >= 60 ? `æ¥è¿‘äº†ï¼å¬åˆ°ã€Œ${bestText}ã€ï¼Œç›®æ ‡ã€Œ${target}ã€` :
            `å¬åˆ°ã€Œ${bestText}ã€ï¼Œå’Œã€Œ${target}ã€å·®è·è¾ƒå¤§ã€‚å»ºè®®å…ˆå¬æ ‡å‡†å‘éŸ³å†æ¨¡ä»¿ã€‚`;
        showFeedback(level, score, bestText, detail);
    }
}

function computeSimilarity(a, b) {
    if (a === b) return 1;
    if (!a || !b) return 0;
    if (b.includes(a)) return 0.95;
    const matrix = [];
    for (let i = 0; i <= b.length; i++) matrix[i] = [i];
    for (let j = 0; j <= a.length; j++) matrix[0][j] = j;
    for (let i = 1; i <= b.length; i++)
        for (let j = 1; j <= a.length; j++)
            matrix[i][j] = b[i-1] === a[j-1] ? matrix[i-1][j-1] :
                Math.min(matrix[i-1][j-1]+1, matrix[i][j-1]+1, matrix[i-1][j]+1);
    const maxLen = Math.max(a.length, b.length);
    return maxLen === 0 ? 1 : 1 - matrix[b.length][a.length] / maxLen;
}

// ===================================================================
// PROGRESS
// ===================================================================
function recordAttempt(word, correct, recognized) {
    if (!STATE.progress[word]) STATE.progress[word] = { correct:0, wrong:0, streak:0, mastered:false, lastWrong:'', wrongCount:0 };
    const p = STATE.progress[word];
    STATE.totalAttempts++;
    if (correct) {
        p.correct++; p.streak++; STATE.totalCorrect++;
        if (p.streak >= STATE.masteryThreshold) p.mastered = true;
    } else {
        p.wrong++; p.streak = 0; p.wrongCount = (p.wrongCount||0) + 1; p.lastWrong = recognized;
    }
    saveState();
}

// ===================================================================
// FEEDBACK
// ===================================================================
function showFeedback(level, score, recognized, detail) {
    const panel = document.getElementById('feedbackPanel');
    panel.className = 'feedback-panel show ' + level;
    document.getElementById('feedbackScore').textContent = score;
    document.getElementById('feedbackLabel').textContent = level === 'correct' ? 'ä¼˜ç§€ï¼' : level === 'partial' ? 'æ¥è¿‘äº†' : 'å†è¯•è¯•';
    document.getElementById('recognizedText').textContent = 'å¬åˆ°ï¼š' + recognized;
    document.getElementById('feedbackDetail').textContent = detail || '';

    const w = STATE.filteredWords[STATE.currentIndex % STATE.filteredWords.length];
    const prog = STATE.progress[w.word] || { correct:0, wrong:0, streak:0 };
    document.getElementById('repeatCounter').textContent = `æœ¬è¯ç»ƒä¹  ${prog.correct+prog.wrong} æ¬¡` +
        (prog.mastered ? ' âœ“ å·²æŒæ¡' : prog.streak > 0 ? ` Â· è¿ç»­æ­£ç¡® ${prog.streak}` : '');

    stopRecordingUI();
}

// ===================================================================
// CHALLENGE
// ===================================================================
function startChallenge() {
    STATE.challengeActive = true;
    STATE.challengeTimeLeft = 60; STATE.challengeCorrect = 0;
    STATE.challengeTotal = 0; STATE.challengeStreak = 0; STATE.challengeBestStreak = 0;
    document.getElementById('challengeIntro').classList.add('hidden');
    document.getElementById('challengeActive').classList.remove('hidden');
    document.getElementById('challengeResult').classList.add('hidden');
    document.getElementById('challengeFeedback').classList.remove('show');
    pickChallengeWord(); updateChallengeUI();
    STATE.challengeTimer = setInterval(() => {
        STATE.challengeTimeLeft--;
        document.getElementById('challengeTimer').textContent = STATE.challengeTimeLeft;
        if (STATE.challengeTimeLeft <= 0) endChallenge();
    }, 1000);
}

function pickChallengeWord() {
    const troubled = WORD_DB.filter(w => { const p = STATE.progress[w.word]; return p && p.wrongCount > 0 && !p.mastered; });
    const pool = troubled.length >= 5 ? troubled : WORD_DB;
    const pick = pool[Math.floor(Math.random() * pool.length)];
    document.getElementById('challengeWord').textContent = pick.word;
    document.getElementById('challengePhonetic').textContent = pick.ipa;
}

function updateChallengeUI() {
    document.getElementById('challengeTimer').textContent = STATE.challengeTimeLeft;
    document.getElementById('challengeProgress').textContent = `æ­£ç¡® ${STATE.challengeCorrect} / å·²ç­” ${STATE.challengeTotal}`;
    document.getElementById('streakCount').textContent = STATE.challengeStreak;
}

function showChallengeFeedback(level, score, recognized) {
    STATE.challengeTotal++;
    if (level !== 'wrong') {
        STATE.challengeCorrect++; STATE.challengeStreak++;
        if (STATE.challengeStreak > STATE.challengeBestStreak) STATE.challengeBestStreak = STATE.challengeStreak;
    } else { STATE.challengeStreak = 0; }
    updateChallengeUI();
    const panel = document.getElementById('challengeFeedback');
    panel.className = 'feedback-panel show ' + level;
    document.getElementById('challengeFeedbackScore').textContent = score;
    document.getElementById('challengeRecognizedText').textContent = 'å¬åˆ°ï¼š' + recognized;
    stopRecordingUI();
    setTimeout(() => { panel.classList.remove('show'); pickChallengeWord(); }, STATE.useGemini ? 800 : 1200);
}

function endChallenge() {
    clearInterval(STATE.challengeTimer); STATE.challengeActive = false;
    document.getElementById('challengeActive').classList.add('hidden');
    document.getElementById('challengeResult').classList.remove('hidden');
    document.getElementById('resultCorrect').textContent = STATE.challengeCorrect;
    document.getElementById('resultTotal').textContent = STATE.challengeTotal;
    document.getElementById('resultAccuracy').textContent = STATE.challengeTotal > 0 ? Math.round(STATE.challengeCorrect/STATE.challengeTotal*100)+'%' : 'â€”';
    document.getElementById('resultBestStreak').textContent = STATE.challengeBestStreak;
}

// ===================================================================
// BROWSE
// ===================================================================
function renderBrowseList() {
    const c = document.getElementById('wordListContainer');
    const words = STATE.currentCategory === 'all' ? WORD_DB : WORD_DB.filter(w => w.cat === STATE.currentCategory);
    c.innerHTML = words.map(w => {
        const p = STATE.progress[w.word];
        let st = 'new', stT = 'æœªç»ƒä¹ ';
        if (p) { if (p.mastered) { st='mastered'; stT='å·²æŒæ¡'; } else if (p.correct+p.wrong>0) { st='practicing'; stT=`${p.correct}/${p.correct+p.wrong}`; } }
        return `<div class="word-list-item" data-word="${w.word}"><div><div class="wl-word">${w.word}</div><div class="wl-phonetic">${w.ipa}</div></div><span class="wl-status ${st}">${stT}</span></div>`;
    }).join('');
    c.querySelectorAll('.word-list-item').forEach(item => {
        item.addEventListener('click', () => {
            const wt = item.dataset.word;
            let idx = STATE.filteredWords.findIndex(w => w.word === wt);
            if (idx < 0) {
                STATE.currentCategory = 'all'; filterWords();
                idx = STATE.filteredWords.findIndex(w => w.word === wt);
                document.querySelectorAll('#trainCategoryPills .pill').forEach(p => p.classList.toggle('active', p.dataset.cat === 'all'));
            }
            STATE.currentIndex = idx;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector('[data-tab="train"]').classList.add('active');
            document.getElementById('tab-train').classList.add('active');
            showCurrentWord();
        });
    });
}

// ===================================================================
// REPORT
// ===================================================================
function renderReport() {
    const masteredN = Object.values(STATE.progress).filter(p => p.mastered).length;
    const acc = STATE.totalAttempts > 0 ? Math.round(STATE.totalCorrect/STATE.totalAttempts*100) : 0;
    document.getElementById('reportStats').innerHTML = `
        <div class="stat-box"><div class="stat-value">${STATE.totalAttempts}</div><div class="stat-label">æ€»ç»ƒä¹ æ¬¡æ•°</div></div>
        <div class="stat-box"><div class="stat-value">${acc}%</div><div class="stat-label">å‡†ç¡®ç‡</div></div>
        <div class="stat-box"><div class="stat-value">${masteredN}</div><div class="stat-label">å·²æŒæ¡</div></div>
        <div class="stat-box"><div class="stat-value">${WORD_DB.length - masteredN}</div><div class="stat-label">å¾…ç»ƒä¹ </div></div>`;

    // Trouble list
    const trouble = Object.entries(STATE.progress).filter(([_,p]) => p.wrongCount > 0).sort((a,b) => b[1].wrongCount-a[1].wrongCount).slice(0,10);
    if (trouble.length > 0) {
        document.getElementById('troubleList').innerHTML = trouble.map(([word,p]) => {
            const db = WORD_DB.find(w => w.word === word);
            return `<div class="trouble-item"><div><div class="trouble-word">${word}</div><div class="trouble-pattern">${db?.confuse && db.confuse!=='â€“' ? 'â†’ /'+db.confuse+'/' : ''}</div></div><div class="trouble-count">é”™ ${p.wrongCount} æ¬¡</div></div>`;
        }).join('');
    }

    // Category accuracy
    const cats = [...new Set(WORD_DB.map(w => w.cat))];
    document.getElementById('categoryAccuracy').innerHTML = cats.map(cat => {
        let cc=0, ct=0;
        WORD_DB.filter(w => w.cat===cat).forEach(w => { const p = STATE.progress[w.word]; if (p) { cc += p.correct; ct += p.correct+p.wrong; } });
        const pct = ct > 0 ? Math.round(cc/ct*100) : 0;
        return `<div style="margin-bottom:12px;"><div style="display:flex;justify-content:space-between;margin-bottom:4px;"><span style="font-size:13px;">${cat}</span><span style="font-size:12px;color:var(--text-dim);">${ct>0?pct+'%':'æœªç»ƒä¹ '}</span></div><div class="progress-bar-bg"><div class="progress-bar-fill" style="width:${pct}%"></div></div></div>`;
    }).join('');

    // Habit analysis
    if (STATE.totalAttempts >= 10) {
        const patterns = {};
        WORD_DB.forEach(w => { const p = STATE.progress[w.word]; if (p && p.wrongCount > 1 && w.confuse && w.confuse !== 'â€“') patterns[w.confuse] = (patterns[w.confuse]||0) + p.wrongCount; });
        const sorted = Object.entries(patterns).sort((a,b) => b[1]-a[1]);
        if (sorted.length > 0) {
            const tips = {
                's/f':'théŸ³å¸¸è¢«æ›¿ä»£ä¸º /s/ æˆ– /f/ã€‚èˆŒå°–å¿…é¡»ç¢°åˆ°ä¸Šé½¿ã€‚', 's':'théŸ³å®¹æ˜“å‘æˆ /s/ã€‚å…ˆæŠŠèˆŒå°–ä¼¸åˆ°é½¿é—´å†å‘éŸ³ã€‚',
                'd/z':'æµŠéŸ³thè¢«æ›¿ä»£ã€‚èˆŒå°–é½¿é—´+å£°å¸¦æŒ¯åŠ¨ã€‚', 'd':'æµŠéŸ³thå‘æˆäº† /d/ã€‚èˆŒå°–éœ€è¦åœ¨é½¿é—´ã€‚',
                'l':'réŸ³å‘æˆäº†léŸ³ã€‚réŸ³æ—¶èˆŒå¤´ä¸ç¢°ä»»ä½•åœ°æ–¹ã€‚', 'r':'léŸ³å‘æˆäº†réŸ³ã€‚léŸ³èˆŒå°–ç¢°ä¸Šé½¿é¾ˆã€‚',
                'w':'véŸ³å‘æˆäº†wéŸ³ã€‚vè¦ä¸Šé½¿ç¢°ä¸‹å”‡ã€‚', 'iË':'é•¿çŸ­å…ƒéŸ³æ··æ·†ã€‚/iË/æ›´é•¿æ›´ç´§ï¼Œ/Éª/æ›´çŸ­æ›´æ¾ã€‚',
                'Éª':'çŸ­å…ƒéŸ³è¢«æ‹‰é•¿ã€‚ä¿æŒçŸ­ä¿ƒã€‚', 'Ã¦':'/Ã¦/å‘ä¸åˆ°ä½ã€‚å˜´è¦å¤§å¼ ã€‚', 'e':'/e/å’Œ/Ã¦/æ··æ·†ã€‚',
                'e/É‘':'/Ã¦/éŸ³å‘ä¸å‡†ã€‚ä¸­å›½äººæœ€éš¾çš„å…ƒéŸ³ä¹‹ä¸€ã€‚', 'Éªd':'-edå°¾éŸ³è§„åˆ™ï¼šæ¸…â†’/t/ï¼ŒæµŠâ†’/d/ï¼Œt/dâ†’/Éªd/ã€‚',
                'Å‹':'/n/å’Œ/Å‹/æ··æ·†ã€‚/Å‹/èˆŒæ ¹ç¢°è½¯è…­ã€‚', 'Å‹É¡':'ngåé¢å¤šåŠ äº†/É¡/ã€‚', 'n/Å‹É¡':'/Å‹/å‘éŸ³ä¸å‡†ã€‚',
                'uË':'é•¿çŸ­uæ··æ·†ã€‚', 'ÊŠ':'çŸ­uè¢«æ‹‰é•¿ã€‚', 'É‘':'/ÊŒ/å’Œ/É‘Ë/æ··æ·†ã€‚', 'dÊ’':'/Ê’/å‘æˆäº†/dÊ’/ã€‚', 'tÊƒ':'chçš„ç‰¹æ®Šå‘éŸ³æ³¨æ„ã€‚',
            };
            document.getElementById('habitAnalysis').innerHTML = sorted.slice(0,5).map(([p,count]) =>
                `<div style="margin-bottom:12px;padding:10px 14px;background:var(--bg-elevated);border-radius:8px;">
                    <div style="font-size:14px;font-weight:500;color:var(--red);margin-bottom:4px;">å®¹æ˜“å‘æˆ /${p}/ (${count}æ¬¡)</div>
                    <div style="font-size:12px;color:var(--text-secondary);line-height:1.5;">${tips[p]||'å¤šç»ƒä¹ ã€‚'}</div>
                </div>`
            ).join('');
        }
    }
}

// ===================================================================
// CONTROLS
// ===================================================================
function setupControls() {
    document.getElementById('playStandardBtn').addEventListener('click', () => playStandard());
    document.getElementById('recordBtn').addEventListener('click', startRecording);
    document.getElementById('challengeRecordBtn').addEventListener('click', startRecording);
    document.getElementById('nextBtn').addEventListener('click', nextWord);

    document.getElementById('speedDown').addEventListener('click', () => {
        STATE.speechRate = Math.max(0.3, STATE.speechRate - 0.1);
        document.getElementById('speedLabel').textContent = STATE.speechRate.toFixed(1)+'x'; saveState();
    });
    document.getElementById('speedUp').addEventListener('click', () => {
        STATE.speechRate = Math.min(2.0, STATE.speechRate + 0.1);
        document.getElementById('speedLabel').textContent = STATE.speechRate.toFixed(1)+'x'; saveState();
    });

    document.getElementById('startChallengeBtn').addEventListener('click', startChallenge);
    document.getElementById('retryChallengeBtn').addEventListener('click', () => {
        document.getElementById('challengeResult').classList.add('hidden'); startChallenge();
    });

    document.getElementById('voiceSelect').addEventListener('change', e => { STATE.voiceLang = e.target.value; saveState(); });
    document.getElementById('masteryThreshold').addEventListener('change', e => { STATE.masteryThreshold = parseInt(e.target.value)||5; saveState(); });

    // Gemini config
    document.getElementById('geminiSaveBtn').addEventListener('click', () => {
        const key = document.getElementById('geminiKeyInput').value.trim();
        if (key && key !== 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢') {
            STATE.geminiKey = key;
            STATE.geminiModel = document.getElementById('geminiModelSelect').value;
            STATE.useGemini = true;
            document.getElementById('geminiKeyInput').value = 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢';
            document.getElementById('geminiStatus').textContent = 'å·²é…ç½® â€” æ¨¡å‹: ' + STATE.geminiModel;
            document.getElementById('geminiStatus').className = 'api-status connected';
            saveState();
        } else if (!key) {
            STATE.geminiKey = ''; STATE.useGemini = false;
            document.getElementById('geminiStatus').textContent = 'æœªé…ç½® â€” ä½¿ç”¨æµè§ˆå™¨è¯­éŸ³è¯†åˆ«';
            document.getElementById('geminiStatus').className = 'api-status';
            saveState();
        }
    });

    document.getElementById('geminiModelSelect').addEventListener('change', e => {
        STATE.geminiModel = e.target.value;
        if (STATE.useGemini) {
            document.getElementById('geminiStatus').textContent = 'å·²é…ç½® â€” æ¨¡å‹: ' + STATE.geminiModel;
        }
        saveState();
    });

    document.getElementById('resetBtn').addEventListener('click', () => {
        if (confirm('ç¡®å®šæ¸…é™¤æ‰€æœ‰ç»ƒä¹ è¿›åº¦ï¼Ÿ')) {
            STATE.progress = {}; STATE.totalAttempts = 0; STATE.totalCorrect = 0;
            saveState(); showCurrentWord(); renderReport();
        }
    });

    // AI Generate
    document.getElementById('aiGenerateBtn').addEventListener('click', generateAIPhrases);

    // Keyboard
    document.addEventListener('keydown', e => {
        if (e.target.matches('input, select')) return;
        if (e.code === 'Space') { e.preventDefault(); startRecording(); }
        if (e.code === 'ArrowRight') { e.preventDefault(); nextWord(); }
        if (e.code === 'Enter') { e.preventDefault(); playStandard(); }
    });
}

// ===================================================================
// AI PHRASE GENERATION
// ===================================================================
async function generateAIPhrases() {
    if (!STATE.useGemini) {
        document.getElementById('aiGenerateNoKey').classList.remove('hidden');
        setTimeout(() => document.getElementById('aiGenerateNoKey').classList.add('hidden'), 3000);
        return;
    }

    // Analyze weak points
    const weakPatterns = [];
    const weakCats = [];
    WORD_DB.forEach(w => {
        const p = STATE.progress[w.word];
        if (p && p.wrongCount > 0) {
            if (w.confuse && w.confuse !== 'â€“') weakPatterns.push(w.confuse);
            if (!weakCats.includes(w.cat)) weakCats.push(w.cat);
        }
    });

    // Count pattern frequency
    const patternCounts = {};
    weakPatterns.forEach(p => patternCounts[p] = (patternCounts[p]||0) + 1);
    const topPatterns = Object.entries(patternCounts).sort((a,b) => b[1]-a[1]).slice(0,3).map(e => e[0]);

    // Also look at current word's category
    const currentWord = STATE.filteredWords[STATE.currentIndex % STATE.filteredWords.length];
    const currentCat = currentWord?.cat || '';

    let focusDescription = '';
    if (topPatterns.length > 0) {
        const patternNames = {
            's/f':'théŸ³(Î¸)å¸¸å‘æˆsæˆ–f', 's':'théŸ³å‘æˆs', 'd/z':'æµŠéŸ³th(Ã°)å‘æˆdæˆ–z', 'd':'æµŠéŸ³thå‘æˆd',
            'l':'réŸ³å‘æˆl', 'r':'léŸ³å‘æˆr', 'w':'véŸ³å‘æˆw', 'iË':'é•¿çŸ­iæ··æ·†', 'Éª':'çŸ­iè¢«æ‹‰é•¿',
            'Ã¦':'/Ã¦/å‘ä¸åˆ°ä½', 'e':'/e/å’Œ/Ã¦/æ··æ·†', 'e/É‘':'/Ã¦/å‘ä¸å‡†', 'Éªd':'-edå°¾éŸ³è§„åˆ™ä¸ç†Ÿ',
            'Å‹':'nå’Œngæ··æ·†', 'Å‹É¡':'ngåå¤šåŠ g', 'uË':'é•¿çŸ­uæ··æ·†', 'ÊŠ':'çŸ­uè¢«æ‹‰é•¿',
            'É‘':'/ÊŒ/å’Œ/É‘Ë/æ··æ·†', 'dÊ’':'/Ê’/å‘æˆ/dÊ’/', 'tÊƒ':'chç‰¹æ®Šå‘éŸ³',
        };
        focusDescription = 'å­¦ç”Ÿçš„è–„å¼±ç‚¹ï¼š' + topPatterns.map(p => patternNames[p] || p).join('ã€');
    } else {
        focusDescription = 'å­¦ç”Ÿåˆšå¼€å§‹ç»ƒä¹ ï¼Œå½“å‰ç»ƒä¹ ç±»åˆ«æ˜¯ï¼š' + currentCat;
    }

    // Show loading
    document.getElementById('aiGenerateBtn').style.display = 'none';
    document.getElementById('aiGenerateLoading').classList.remove('hidden');
    document.getElementById('aiGeneratedList').classList.add('hidden');

    const prompt = `You are an English pronunciation coach for Chinese Mandarin speakers.

${focusDescription}

Generate exactly 5 short English phrases (3-7 words each) specifically designed to train these weak pronunciation areas. Each phrase should be a natural, common expression that a native speaker would actually say.

Respond ONLY with a JSON array, no markdown:
[
  {
    "phrase": "the phrase in English",
    "ipa": "simplified IPA transcription",
    "zh": "Chinese translation",
    "focus": "what pronunciation point this trains (in Chinese, very brief)",
    "tip": "one-line pronunciation advice in Chinese"
  }
]

Make phrases progressively harder. Include at least 2 phrases that combine multiple weak areas.`;

    try {
        const url = `https://generativelanguage.googleapis.com/v1beta/models/${STATE.geminiModel}:generateContent?key=${STATE.geminiKey}`;
        const resp = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: { temperature: 0.8, maxOutputTokens: 800 }
            }),
        });

        if (!resp.ok) throw new Error('HTTP ' + resp.status);
        const data = await resp.json();
        const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';

        // Parse JSON
        let jsonStr = text;
        const match = text.match(/```(?:json)?\s*([\s\S]*?)```/);
        if (match) jsonStr = match[1];
        const arrMatch = jsonStr.match(/\[[\s\S]*\]/);
        if (arrMatch) jsonStr = arrMatch[0];

        const phrases = JSON.parse(jsonStr.trim());

        // Add to dynamic word list and render
        const container = document.getElementById('aiGeneratedContent');
        container.innerHTML = phrases.map((p, i) => `
            <div class="ai-phrase-item" data-ai-index="${i}">
                <div class="ai-phrase-word">${p.phrase}</div>
                <div class="ai-phrase-ipa">${p.ipa || ''}</div>
                <div class="ai-phrase-zh">${p.zh}</div>
                <div class="ai-phrase-focus">ğŸ¯ ${p.focus}</div>
            </div>
        `).join('');

        // Store generated phrases for practice
        STATE.aiPhrases = phrases;

        // Click to load into trainer
        container.querySelectorAll('.ai-phrase-item').forEach(item => {
            item.addEventListener('click', () => {
                const idx = parseInt(item.dataset.aiIndex);
                const p = STATE.aiPhrases[idx];
                if (!p) return;

                // Inject into filteredWords temporarily
                const tempWord = {
                    word: p.phrase, ipa: p.ipa || '', zh: p.zh,
                    cat: 'AIç”Ÿæˆ', tip: p.tip || p.focus, confuse: 'â€“'
                };

                // Add to WORD_DB if not already there
                if (!WORD_DB.find(w => w.word === p.phrase)) {
                    WORD_DB.push(tempWord);
                }

                // Switch to this word
                filterWords();
                const newIdx = STATE.filteredWords.findIndex(w => w.word === p.phrase);
                if (newIdx >= 0) STATE.currentIndex = newIdx;
                else {
                    STATE.currentCategory = 'all';
                    document.querySelectorAll('#trainCategoryPills .pill').forEach(pill => pill.classList.toggle('active', pill.dataset.cat === 'all'));
                    filterWords();
                    // rebuild pills since we have a new category
                    buildCategoryPills();
                    STATE.currentIndex = STATE.filteredWords.findIndex(w => w.word === p.phrase);
                }
                showCurrentWord();

                // Scroll to top
                document.getElementById('tab-train').scrollIntoView({ behavior: 'smooth' });
            });
        });

        document.getElementById('aiGeneratedList').classList.remove('hidden');

    } catch(err) {
        console.error('AI generate error', err);
        const container = document.getElementById('aiGeneratedContent');
        container.innerHTML = `<div style="font-size:12px; color:var(--red); text-align:center; padding:10px;">ç”Ÿæˆå¤±è´¥: ${err.message}</div>`;
        document.getElementById('aiGeneratedList').classList.remove('hidden');
    }

    document.getElementById('aiGenerateLoading').classList.add('hidden');
    document.getElementById('aiGenerateBtn').style.display = 'flex';
}

// ===================================================================
// BOOT
// ===================================================================
if (speechSynthesis.onvoiceschanged !== undefined) speechSynthesis.onvoiceschanged = () => {};
speechSynthesis.getVoices();
init();
</script>
</body>
</html>
